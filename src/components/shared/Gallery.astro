---
import type { ImageMetadata } from "astro";
import { Image, getImage } from "astro:assets";

interface Props {
  imageFolder: string;
}

const { imageFolder } = Astro.props;
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/*/*"
);
const imagePaths = Object.keys(images).filter((imagePath) => {
  return imagePath.startsWith(`/src/assets/images/${imageFolder}/`);
});
---

<div
  id="gallery"
  class="container mx-auto px-2 pb-2 py-6 lg:py-10 masonry-grid"
>
  {
    imagePaths.map(async (imagePath, index) => {
      const image = images[imagePath]();
      const resolvedImage = await image;
      const optimizedImage = await getImage({
        src: resolvedImage.default,
        width: 1920,
        format: "avif",
      });

      return (
        <a
          href={optimizedImage.src}
          data-pswp-width={optimizedImage.attributes.width}
          data-pswp-height={optimizedImage.attributes.height}
          target="_blank"
          class="masonry-item overflow-hidden rounded-sm border border-slate-400/20 hover:border-gold transition-all duration-300 group hover:shadow-xl hover:shadow-gold/10 block mb-2"
        >
          <Image
            src={resolvedImage.default}
            alt={`GalerÃ­a ${imageFolder} - Imagen ${index + 1}`}
            widths={[400, 600, 800]}
            loading={index < 4 ? "eager" : "lazy"}
            sizes="(max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
            format="avif"
            class="object-cover w-full h-auto transition duration-500 ease-out transform group-hover:scale-105"
          />
        </a>
      );
    })
  }
</div>

<style is:global>
  .masonry-grid {
    column-count: 2;
    column-gap: 0.5rem;
  }

  @media (min-width: 768px) {
    .masonry-grid {
      column-count: 3;
    }
  }

  @media (min-width: 1024px) {
    .masonry-grid {
      column-count: 4;
    }
  }

  .masonry-item {
    break-inside: avoid;
    page-break-inside: avoid;
    display: inline-block;
    width: 100%;
  }

  .pswp__bg {
    background-color: rgba(0, 0, 0, 0.95);
  }

  .pswp__img {
    object-fit: contain;
  }
</style>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  let lightbox: PhotoSwipeLightbox | null = null;

  function initGallery() {
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }

    lightbox = new PhotoSwipeLightbox({
      gallery: "#gallery",
      children: "a",
      pswpModule: () => import("photoswipe"),
      padding: { top: 20, bottom: 40, left: 100, right: 100 },
      bgOpacity: 0.95,
      loop: true,
      pinchToClose: true,
      closeOnVerticalDrag: true,
      escKey: true,
      arrowKeys: true,
      returnFocus: true,
      preload: [1, 2],
    });

    lightbox.init();
  }

  document.addEventListener("astro:page-load", initGallery);

  document.addEventListener("astro:before-swap", () => {
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }
  });
</script>
